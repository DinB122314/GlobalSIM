<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - GlobalSim</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #2c3e50; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 8px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    button { margin-left: 10px; padding: 5px 10px; cursor: pointer; }
    .approve { background: #2ecc71; color: white; border: none; border-radius: 4px; }
    .delete { background: #e74c3c; color: white; border: none; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>🔐 GlobalSim Admin Panel</h2>
  <p id="adminEmail">Loading...</p>

  <h3>👥 Users & Balances</h3>
  <ul id="userList">Loading...</ul>

  <h3>📥 Payment Proofs</h3>
  <ul id="paymentList">Loading...</ul>

  <h3>📄 Orders</h3>
  <ul id="orderList">Loading...</ul>

  <script type="module">
    import { auth, onAuthStateChanged } from './firebase.js';
    import {
      getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const db = getFirestore();
    const storage = getStorage();
    const adminUID = "lddTZnjW4ldkBu30c81YcDksFlG3";

    onAuthStateChanged(auth, (user) => {
      if (!user || user.uid !== adminUID) {
        alert("Access denied. Admins only.");
        window.location.href = "login.html";
        return;
      }

      document.getElementById("adminEmail").innerText = "Logged in as: " + user.email;

      // Real-time Users
      onSnapshot(collection(db, "users"), (snapshot) => {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          userList.innerHTML += `<li>${data.email} — $${(data.balance || 0).toFixed(2)}</li>`;
        });
      });

      // Real-time Payments with Approve & Delete
      onSnapshot(collection(db, "payments"), (snapshot) => {
        const paymentList = document.getElementById("paymentList");
        paymentList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          paymentList.innerHTML += `
            <li>
              ${data.email} uploaded proof: 
              <a href="${data.imageUrl}" target="_blank">View</a>
              <button class="approve" onclick="approvePayment('${docSnap.id}')">Approve</button>
              <button class="delete" onclick="deletePayment('${docSnap.id}', '${data.imagePath}')">Delete</button>
            </li>`;
        });
      });

      // Real-time Orders
      onSnapshot(collection(db, "orders"), (snapshot) => {
        const orderList = document.getElementById("orderList");
        orderList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          orderList.innerHTML += `<li>${data.type} — $${data.amount} — ${new Date(data.date.seconds * 1000).toLocaleString()}</li>`;
        });
      });
    });

    // Approve Payment
    window.approvePayment = async (id) => {
      await updateDoc(doc(db, "payments", id), { status: "approved" });
      alert("Payment approved!");
    };

    // Delete Payment + Image
    window.deletePayment = async (id, imagePath) => {
      if (confirm("Are you sure you want to delete this payment proof?")) {
        await deleteDoc(doc(db, "payments", id));
        if (imagePath) {
          const imageRef = ref(storage, imagePath);
          await deleteObject(imageRef);
        }
        alert("Payment proof deleted!");
      }
    };
  </script>
</body>
</html>
