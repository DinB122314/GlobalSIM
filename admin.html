<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - GlobalSim</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f4f4f4;
    }
    button {
      margin-right: 5px;
      padding: 5px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ðŸ‘¥ Users & Balances</h2>
  <table id="usersTable">
    <thead>
      <tr><th>Email</th><th>Balance</th></tr>
    </thead>
    <tbody><tr><td colspan="2">Loading...</td></tr></tbody>
  </table>

  <h2>ðŸ“¥ Payment Proofs</h2>
  <table id="paymentsTable">
    <thead>
      <tr><th>User</th><th>Image</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody><tr><td colspan="4">Loading...</td></tr></tbody>
  </table>

  <h2>ðŸ“„ Orders</h2>
  <table id="ordersTable">
    <thead>
      <tr><th>User</th><th>Order Details</th><th>Date</th></tr>
    </thead>
    <tbody><tr><td colspan="3">Loading...</td></tr></tbody>
  </table>

  <script type="module">
    import { auth, onAuthStateChanged, signOut } from './firebase.js';
    import {
      getFirestore, collection, getDocs, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const db = getFirestore();
    const adminUID = "lddTZnjW4ldkBu30c81YcDksFlG3"; // your admin UID

    onAuthStateChanged(auth, async (user) => {
      if (user?.uid === adminUID) {
        loadUsers();
        loadPayments();
        loadOrders();
      } else {
        alert("Access denied.");
        window.location.href = "login.html";
      }
    });

    async function loadUsers() {
      const snapshot = await getDocs(collection(db, "users"));
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${data.email}</td><td>$${(data.balance || 0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadPayments() {
      const snapshot = await getDocs(collection(db, "paymentProofs"));
      const tbody = document.querySelector("#paymentsTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.userEmail || "Unknown"}</td>
          <td><a href="${data.imageURL}" target="_blank">View</a></td>
          <td>${data.status || "Pending"}</td>
          <td>
            <button onclick="approvePayment('${docSnap.id}')">Approve</button>
            <button onclick="deletePayment('${docSnap.id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadOrders() {
      const snapshot = await getDocs(collection(db, "orders"));
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${data.userEmail || "Unknown"}</td><td>${data.details || ""}</td><td>${data.date || ""}</td>`;
        tbody.appendChild(tr);
      });
    }

    window.approvePayment = async function(id) {
      await updateDoc(doc(db, "paymentProofs", id), { status: "Approved" });
      alert("Payment approved.");
      loadPayments();
    };

    window.deletePayment = async function(id) {
      await deleteDoc(doc(db, "paymentProofs", id));
      alert("Payment deleted.");
      loadPayments();
    };
  </script>
</body>
</html>
