<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    button { padding: 5px 10px; margin-right: 5px; cursor: pointer; }
    img { max-width: 100px; height: auto; }
  </style>
</head>
<body>

<h1>Admin Dashboard</h1>

<h2>ðŸ‘¥ Users & Balances</h2>
<table id="usersTable">
  <tr><th>Email</th><th>Balance</th></tr>
  <tr><td colspan="2">Loading...</td></tr>
</table>

<h2>ðŸ“¥ Payment Proofs</h2>
<table id="proofsTable">
  <tr><th>User</th><th>Image</th><th>Status</th><th>Actions</th></tr>
  <tr><td colspan="4">Loading...</td></tr>
</table>

<h2>ðŸ“„ Orders</h2>
<table id="ordersTable">
  <tr><th>User</th><th>Order Details</th><th>Date</th></tr>
  <tr><td colspan="3">Loading...</td></tr>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, updateDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9xPfQDbAJjPS_6H081FEjSyEQUE80IkY",
  authDomain: "globalsim-54868.firebaseapp.com",
  projectId: "globalsim-54868",
  storageBucket: "globalsim-54868.firebasestorage.app",
  messagingSenderId: "128597882511",
  appId: "1:128597882511:web:e192fa863f3d7976b5a2fa"
};

  const adminUID = "lddTZnjW4ldkBu30c81YcDksFlG3"; 

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, user => {
    if (user && user.uid === adminUID) {
      loadUsers();
      loadPaymentProofs();
      loadOrders();
    } else {
      document.body.innerHTML = "<h1>Access Denied</h1>";
    }
  });

  async function loadUsers() {
    const table = document.getElementById("usersTable");
    table.innerHTML = "<tr><th>Email</th><th>Balance</th></tr>";
    const querySnapshot = await getDocs(collection(db, "users"));
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      table.innerHTML += `<tr>
        <td>${data.email}</td>
        <td>${data.balance}</td>
      </tr>`;
    });
  }

  async function loadPaymentProofs() {
    const table = document.getElementById("proofsTable");
    table.innerHTML = "<tr><th>User</th><th>Image</th><th>Status</th><th>Actions</th></tr>";
    const querySnapshot = await getDocs(collection(db, "paymentProofs"));
    querySnapshot.forEach(async docSnap => {
      const proof = docSnap.data();
      const userDoc = await getDoc(doc(db, "users", proof.uid));
      const userEmail = userDoc.exists() ? userDoc.data().email : "Unknown User";

      table.innerHTML += `<tr>
        <td>${userEmail}</td>
        <td><img src="${proof.imageUrl}" alt="Proof"></td>
        <td>${proof.status}</td>
        <td>
          <button onclick="approveProof('${docSnap.id}', '${proof.uid}', ${proof.amount})">Approve</button>
          <button onclick="deleteProof('${docSnap.id}')">Delete</button>
        </td>
      </tr>`;
    });
  }

  async function loadOrders() {
    const table = document.getElementById("ordersTable");
    table.innerHTML = "<tr><th>User</th><th>Order Details</th><th>Date</th></tr>";
    const querySnapshot = await getDocs(collection(db, "orders"));
    querySnapshot.forEach(async docSnap => {
      const order = docSnap.data();
      const userDoc = await getDoc(doc(db, "users", order.uid));
      const userEmail = userDoc.exists() ? userDoc.data().email : "Unknown User";
      const dateStr = order.date ? new Date(order.date.seconds * 1000).toLocaleString() : "N/A";

      table.innerHTML += `<tr>
        <td>${userEmail}</td>
        <td>${typeof order.details === "string" ? order.details : JSON.stringify(order.details)}</td>
        <td>${dateStr}</td>
      </tr>`;
    });
  }

  window.approveProof = async function(proofId, uid, amount) {
    const userRef = doc(db, "users", uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const currentBalance = userSnap.data().balance || 0;
      await updateDoc(userRef, { balance: currentBalance + amount });
    }
    await updateDoc(doc(db, "paymentProofs", proofId), { status: "approved" });
    loadUsers();
    loadPaymentProofs();
  };

  window.deleteProof = async function(proofId) {
    await deleteDoc(doc(db, "paymentProofs", proofId));
    loadPaymentProofs();
  };
</script>

</body>
</html>

