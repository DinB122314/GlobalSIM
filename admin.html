<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - GlobalSim</title>
</head>
<body>
  <h2>ğŸ” GlobalSim Admin Panel</h2>
  <p id="adminEmail">Loading...</p>

  <h3>ğŸ‘¥ Users & Balances</h3>
  <ul id="userList">Loading...</ul>

  <h3>ğŸ“¥ Payment Proofs</h3>
  <ul id="paymentList">Loading...</ul>

  <h3>ğŸ“„ Orders</h3>
  <ul id="orderList">Loading...</ul>

  <script type="module">
    import { auth, onAuthStateChanged } from './firebase.js';
    import {
      getFirestore,
      collection,
      getDocs,
      deleteDoc,
      updateDoc,
      getDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const db = getFirestore();
    const adminUID = "lddTZnjW4ldkBu30c81YcDksFlG3";

    async function approvePayment(paymentId, userId, amount) {
      const userRef = doc(db, "users", userId);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        alert("User not found!");
        return;
      }

      const currentBalance = userSnap.data().balance || 0;
      const newBalance = currentBalance + amount;

      await updateDoc(userRef, { balance: newBalance });
      await deleteDoc(doc(db, "payments", paymentId));

      alert(`Payment approved! New balance: $${newBalance.toFixed(2)}`);
      location.reload();
    }

    async function deleteItem(collectionName, id) {
      await deleteDoc(doc(db, collectionName, id));
      alert("Item deleted!");
      location.reload();
    }

    async function markOrderCompleted(orderId) {
      const orderRef = doc(db, "orders", orderId);
      await updateDoc(orderRef, { status: "completed" });
      alert("Order marked as completed!");
      location.reload();
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.uid !== adminUID) {
        alert("Access denied. Admins only.");
        window.location.href = "login.html";
        return;
      }

      document.getElementById("adminEmail").innerText = "Logged in as: " + user.email;

      // Load Users
      const usersSnapshot = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      usersSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        userList.innerHTML += `
          <li>
            ${data.email} â€” $${(data.balance || 0).toFixed(2)}
            <button onclick="deleteItem('users', '${docSnap.id}')">Delete</button>
          </li>`;
      });

      // Load Payments
      const paymentSnapshot = await getDocs(collection(db, "payments"));
      const paymentList = document.getElementById("paymentList");
      paymentList.innerHTML = "";
      paymentSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        paymentList.innerHTML += `
          <li>
            ${data.email} uploaded proof: <a href="${data.imageUrl}" target="_blank">View</a> â€” $${data.amount}
            <button onclick="approvePayment('${docSnap.id}', '${data.userId}', ${data.amount})">Approve</button>
            <button onclick="deleteItem('payments', '${docSnap.id}')">Delete</button>
          </li>`;
      });

      // Load Orders
      const orderSnapshot = await getDocs(collection(db, "orders"));
      const orderList = document.getElementById("orderList");
      orderList.innerHTML = "";
      orderSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const status = data.status || "pending";
        orderList.innerHTML += `
          <li>
            ${data.type} â€” $${data.amount} â€” ${new Date(data.date.seconds * 1000).toLocaleString()} â€” Status: ${status.toUpperCase()}
            ${status === "pending" ? `<button onclick="markOrderCompleted('${docSnap.id}')">Mark as Completed</button>` : ""}
            <button onclick="deleteItem('orders', '${docSnap.id}')">Delete</button>
          </li>`;
      });

      // Make functions global
      window.deleteItem = deleteItem;
      window.approvePayment = approvePayment;
      window.markOrderCompleted = markOrderCompleted;
    });
  </script>
</body>
</html>
